# batch_exec
バッチ処理を手軽に並列実行するためのプログラム batch_exec のGPU対応版です(pytorch使用)。

batch_exec.py との違いは、各プロセスが1つのGPUを使用することを想定して、使っていないGPUを番号の若い順に割り当てます。
その際、プロセス毎にGPUロックフィアル(実際はディレクトリ)を作成し、処理が終わったら削除します。

基本的な使い方はオリジナル(CPU版)と同じで、並列実行したい分だけ batch_exec.py を実行すればOKです。
例えば、マシンAで2並列、マシンBで3並列実行したいなら、マシンAで2プロセス、マシンBで3プロセス実行します。

これを実現している仕組みは簡単で、タスクリストの各タスクに対して以下を繰り返します。

1. 出力ファイルが存在していればタスクが既に終了しているので次のタスクへ

2. ロックファイルがあれば既に実行中なので次のタスクへ

3. 出力ファイルもロックファイルもなければロックファイルを作成してタスクを実行

物は試しで、
```
python batch_exec_pytorch1GPU.py task_list.txt . 3
```
を何プロセスか同時に実行してみてください。
50個のタスクが重複なしで順番に実行されます。
別のターミナルで実行する方が挙動がわかりやすいです。

ただし、実際に使用する際には、&をつけて、
```
python batch_exec_pytorch1GPU.py task_list.txt . 3 &
```
を1つのターミナルで何度も実行するのがお薦めです。

なお、batch_exec を実行するサーバーに使用中のGPUがあることを想定していないので、その点は注意してください。

*****

以下、添付ファイルの説明です。

* batch_exec.py: 並列実行するプログラム

  タスクリストのファイル名と、出力ファイルがタスクリストの何番目の引数であるか、の2つに加えて、
  3つ目の引数として、GPUロックフィアル(実際はディレクトリ)を作成するディレクトリを引数にとる。
  3つ目の引数がGPU版の変更点である。
 
  例：
```
python batch_exec.py task_list.txt 3 .
```
* dummy_prog.py: 実行例を示すためのプログラム

  実行すると、2秒待った後に出力ファイルに書き込んで（作成して）終了する。2つめの引数が出力ファイル名である。
  GPU版の変更点として、3つ目の引数はGPUの番号である。

* task_list.txt: 実行例を示すためのタスクリスト

  dummy_prog.pyを50回実行するようになっている。

